---
title: "A Time Series Approach to Forecasting National Influenza Trends"
author: "Team 2: Jun Sik Ryu, Austin Mallie, Cynthia Portales-Loebell"
format:
  pdf:
    toc: true
    toc-depth: 3
    theme: cosmo
    code-fold: false
execute:
  echo: true
  warning: false
  message: false
  working-directory: "/cloud/project"
---


```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = normalizePath("..", mustWork = FALSE))
library(fpp3)
library(cdcfluview)
library(tidyverse)
library(lubridate)
library(urca)
library(ggplot2)
library(fable)
```

# Introduction

This exploratory data analysis investigates influenza-like illness (ILI) patterns using weekly ILINet data from the CDC.\
The goal is to understand seasonal patterns, data quality, and characteristics before modeling.

# Data Import and Cleaning

```{r}
# Import national ILINet data
ili_raw <- ilinet(region = "national")
```

```{r}
glimpse(ili_raw)
head(ili_raw)
```

Convert to tsibble

```{r table}
names(ili_raw)

```

```{r make-tsibble}
ili_ts <- ili_raw |>
  mutate(week = yearweek(week_start)) |>
  as_tsibble(index = week)

ili_ts
```

# **Exploratory Data Analysis**

```{r check-gaps}
ili_ts |> has_gaps()
```

```{r missing}

#Check for missing ILI values
ili_ts |> filter(is.na(weighted_ili))
```

```{r plot-series}

# Plot the series
ili_ts |>
  ggplot(aes(x = week, y = weighted_ili)) +
  geom_line() +
  labs(
    title = "Weekly Weighted ILI (%) in the United States",
    subtitle = "CDC ILINet data, starting 1997",
    x = "Week",
    y = "Weighted ILI (%)"
  )

```

```{r seasonal-plot}

# Seasonal plot
ili_ts |>
  gg_season(weighted_ili) +
  labs(
    title = "Seasonal Pattern of Weekly Weighted ILI (%)",
    subtitle = "ILI cycles show consistent winter peaks across years",
    x = "Week of Year",
    y = "Weighted ILI (%)"
  )
```

```{r stl-decomposition}

# STL decomposition
ili_ts |>
  model(STL(weighted_ili)) |>
  components() |>
  autoplot() +
  labs(
    title = "STL Decomposition of Weekly Weighted ILI (%)",
    subtitle = "Shows seasonal, trend, and remainder components",
    x = "Week",
    y = NULL
  )
```

```{r plot-moving-average}

# Plot a 3 week centered moving average
ili_ts |>
  mutate(
    ma_3 = slider::slide_dbl(
      weighted_ili,
      mean,
      .before = 1,
      .after = 1,
      .complete = TRUE
    )
  ) |>
  ggplot(aes(x = week)) +
  geom_line(aes(y = weighted_ili), alpha = 0.4, color = "steelblue") +
  geom_line(aes(y = ma_3), color = "red", size = 1) +
  labs(
    title = "3-Week Centered Moving Average of Weighted ILI (%)",
    subtitle = "Smoothing highlights the underlying influenza seasonal pattern",
    x = "Week",
    y = "Weighted ILI (%)"
  )
```

```{r summary}

# Summary statistics
ili_ts |>
  as_tibble() |>   
  summarise(
    min = min(weighted_ili),
    q1 = quantile(weighted_ili, 0.25),
    median = median(weighted_ili),
    mean = mean(weighted_ili),
    q3 = quantile(weighted_ili, 0.75),
    max = max(weighted_ili)
  )

```

```{r acf}

# Autocorrelation Function (ACF) of Weekly Weighted ILI (%)

ili_ts |>
  ACF(weighted_ili) |>
  autoplot() +
  labs(
    title = "Autocorrelation Function of Weighted ILI (%)",
    subtitle = "Strong annual seasonality reflected in large spikes at 52-week lags",
    x = "Lag (weeks)",
    y = "ACF"
  )

```

```{r pacf}

# Partial Autocorrelation Function (PACF) 
ili_ts |>
  PACF(weighted_ili) |>
  autoplot() +
  labs(
    title = "Partial Autocorrelation Function of Weighted ILI (%)",
    subtitle = "PACF highlights autoregressive behavior and seasonal effects",
    x = "Lag (weeks)",
    y = "PACF"
  )
```

```{r outliers}

# Check for outliers via STL remainder
ili_ts |>
  model(STL(weighted_ili)) |>
  components() |>
  autoplot(remainder) +
  labs(title = "Outlier Inspection via STL Remainder")

```

# Pre-Processing and Data Preparation

```{r var stabilization}

# Log transformation
ili_ts <- ili_ts |>
  mutate(log_ili = log(weighted_ili + 1e-6))

ili_ts |> autoplot(log_ili) + ggtitle("Weighted ILI (%) after Log Transformation")
```

# Train/Test Split

```{r split}

# Train/test split
train <- ili_ts |> filter(week < yearweek("2020 W01"))
test  <- ili_ts |> filter(week >= yearweek("2020 W01"))
```

# Modeling
**The goal is to compare ETS, ARIMA, and TSLM models to determine which provides the most accurate short-term forecasts of weekly influenza-like illness.**

TSLM

```{r tslm-model}
fit_tslm <- train |>
  model(
    tslm = TSLM(weighted_ili ~ trend() + season())
  )

report(fit_tslm)
```

```{r tslm-plot}
tslm_aug <- fit_tslm |>
augment()

autoplot(train, weighted_ili) +
autolayer(tslm_aug, .fitted, color = "blue") +
labs(
title = "TSLM Fit on Weekly Weighted ILI (%)",
x = "Week",
y = "Weighted ILI (%)"
)
```

```{r tslm-forecast}
fc_tslm <- fit_tslm |>
forecast(h = nrow(test))

fc_tslm |>
autoplot(train, level = NULL) +
autolayer(test, weighted_ili, color = "black") +
labs(
title = "TSLM Forecast vs Actual (Original Scale)",
x = "Week",
y = "Weighted ILI (%)"
)
```

```{r tslm-accuracy}
accuracy_tslm <- fc_tslm |>
accuracy(test)

accuracy_tslm
```

ARIMA Modeling

```{r ARIMA}

# Fit model on training data
fit_arima <- train |>
  model(
    arima = ARIMA(log_ili)
  )

# Review model output 
report(fit_arima)
```

```{r forecast-arima}

# Forecast with Test
fc_arima <- fit_arima |> forecast(h= nrow(test))

# Plot forecast versus actuals
fc_arima |>
  autoplot(train, level = NULL) +
  autolayer(test, log_ili, color = "black") +
  ggtitle("ARIMA Forecast vs Actual (Log-Scale)") +
  xlab("Week") + ylab("Log(ILI)")
```

```{r accuracy-arima}

# Accuracy metrics 
accuracy_arima <- fc_arima |>
  accuracy(test)

accuracy_arima
```

ETS Modeling

```{r ets-model}
# ETS models: manual non-seasonal ETS(A,A,N) and auto ETS with no seasonality
fit_ets <- train |>
  model(
    ets_manual = ETS(weighted_ili ~ error("A") + trend("A") + season("N")),  # ETS(A,A,N)
    ets_auto   = ETS(weighted_ili ~ season("N"))                             # auto ETS, non-seasonal
  )

report(fit_ets)


# Forecast the same horizon as the test set

fc_ets <- fit_ets |>
forecast(h = nrow(test))

# Plot ETS forecasts vs actual values on the original scale

fc_ets |>
autoplot(train, level = NULL) +
autolayer(test, weighted_ili, color = "black") +
labs(
title = "ETS Forecasts vs Actual (Original Scale)",
x = "Week",
y = "Weighted ILI (%)"
)

```
```{r}
# Accuracy metrics for ETS models on the test set

accuracy_ets <- fc_ets |>
accuracy(test)

accuracy_ets

```
```{r}
# Manual vs Auto ETS forecasts plotted over the full series


fc_ets_full <- fit_ets |>
forecast(h = nrow(test))

fc_ets_full |>
autoplot(ili_ts) +
labs(
title = "Manual vs Auto ETS Forecasts of Weighted ILI (HHS Region 4)",
x = "Week",
y = "Weighted ILI (%)"
)

```
```{r}
# Fit a manual ETS(A,A,N) model on the full series for diagnostics

fit_ets_full <- ili_ts |>
model(
ets_manual = ETS(weighted_ili ~ error("A") + trend("A") + season("N"))
)

# Residual diagnostics plot (like gg_tsresiduals in the ETS document)

fit_ets_full |>
gg_tsresiduals()

# Ljung-Box test on residuals (check for remaining autocorrelation)

ets_ljung_box <- fit_ets_full |>
augment() |>
features(.innov, ljung_box, lag = 24)

ets_ljung_box

```

```{r ets-auto-manual-damped}
# Fit ETS models on the full series 
fit_ets_all_full <- ili_ts |>
  model(
    ets_manual = ETS(weighted_ili ~ error("A") + trend("A")  + season("N")),  # ETS(A,A,N)
    ets_auto   = ETS(weighted_ili ~ season("N")),                             # auto ETS, non-seasonal
    ets_damped = ETS(weighted_ili ~ error("A") + trend("Ad") + season("N"))   # damped trend
  )

# Forecast ahead (e.g., next 52 weeks)
fc_ets_all_full <- fit_ets_all_full |>
  forecast(h = 52)

# Plot like the original ETS figure
fc_ets_all_full |>
  autoplot(ili_ts, level = c(80, 95)) +
  coord_cartesian(ylim = c(0, 10)) +  # adjust if your %wILI scale is different
  labs(
    title = "Manual vs Auto vs Damped ETS Forecasts of %wILI (HHS Region 4)",
    x = "Year-Week",
    y = "%wILI"
  )

```